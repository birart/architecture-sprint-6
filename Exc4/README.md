# Проектирование ОСАГО

## Требования
1. Максимальное время ожидания клиентом информации по заявкам - 60сек.
2. Max RPS osago-aggregator - 2.5k.

## Описание взаимодействия:

1. Web приложение устанавливает Websocket соединение с core-app и отправляет запрос на создание заявки осаго. Это позволит получать события от сервера с ответами от каждой страховой по мере их поступления. 

2. Core-app присваивает заявке номер и отправляет синхронный REST запрос на создание заявки в osago-aggregator. Osago-aggregator отвечает статусом HTTP 202 Accepted и сore-app с помощью Server push отбражает пользователю номер его заявки и сообщает пользователю о том, что запрос обрабатывается. Таким образом клиент видит что все в порядке. Для того, чтобы ограничить запросы от одного пользователя можно реализовать Rate Limit на стороне core-app. 

3. В это время osago-aggregator отправляет запросы в страховые API, асинхронно дожидаясь ответа. Тут мы можем реализовать Circuit Breaker для каждого API, если оно недоступно или возвращает ошибку, чтобы не тратить ресурсы и не стучаться в недоступное API. Таймаут на каждый запрос можно установить вблизи 60 секунд, так как каждый запрос ожидает асинхронно. В худжем случае ни одно из API не ответит, мы пометим его как невалидное и пользователь подождет ~60сек.  
После получения ответа от API, osago-aggregator публикует событие в очередь сообщений с информацией по страховой компании и условиям для этой заявки. Тем самым мы реализуем взаимодействие публикация-подписка и не ждем синхронно в core-app ответа от всех страховых. Собственной БД у сервиса нет, так как он публикует полученную информацию в очередь.

4. Core-app читает событие из очереди и по мере поступления данных с помощью Server push отображает клиенту новые предложения от страховой компании.
При масштабировании osago-aggregator в таком подходе мы можем использовать load-balancer перед osago-aggregator, тогда каждый запрос будет обрабатываться в отдельном инстансе и инстанс будет публиковать события в рамках своей заявки.